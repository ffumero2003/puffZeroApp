import {
  Manrope_300Light,
  Manrope_400Regular,
  Manrope_500Medium,
  Manrope_600SemiBold,
  Manrope_700Bold,
  Manrope_800ExtraBold,
  useFonts,
} from "@expo-google-fonts/manrope";

import { Stack, router, usePathname, useSegments } from "expo-router";
import { StatusBar } from "expo-status-bar";
import * as WebBrowser from "expo-web-browser";
import { useEffect } from "react";

import { ROUTES } from "@/src/constants/routes";
import Splash from "../src/components/system/splash";
import { AuthProvider, useAuth } from "../src/providers/auth-provider";
import { OnboardingProvider, useOnboarding } from "../src/providers/onboarding-provider";

// üëâ NECESARIO para PKCE + expo-web-browser
WebBrowser.maybeCompleteAuthSession();

function RootNavigation() {
  const { user, initializing, authInProgress, authFlow } = useAuth();
  const { loading } = useOnboarding();
  const segments = useSegments();
  // üî• TEMPORAL ‚Äì hasta implementar suscripciones reales
  const isPremium = false;
  const pathname = usePathname();


  // üü£ Importar DEV_MODE
  const { DEV_MODE, DEV_SCREEN } = require("../src/config/dev");

  const isLoading = initializing || loading;


  useEffect(() => {
    if (DEV_MODE) {
      router.replace(DEV_SCREEN);
      return;
    }

    if (authInProgress || isLoading) return;

    const [group] = segments;
    const isAuth = group === "(auth)";
    const isOnboarding = group === "(onboarding)";
    const isPostSignup = pathname.startsWith("/post-signup");

    /**
     * üîí RESET PASSWORD
     */
    if (group === "reset-password") {
      if (!user) {
        router.replace(ROUTES.ONBOARDING);
      }
      return;
    }

    /**
     * üö™ NO AUTH
     */
    if (!user) {
      if (!isAuth && !isOnboarding) {
        router.replace(ROUTES.ONBOARDING);
      }
      return;
    }

    /**
     * üè† AUTHENTICATED
     */
    if (!isPremium) {
      // Puede estar en post-signup (incluye paywall)
      if (isPostSignup) return;

      // Bloqueado fuera del post-signup
      router.replace(ROUTES.POST_SIGNUP_REVIEW);
      return;
    }

    /**
     * ‚úÖ PREMIUM
     */
    if (group !== "(app)") {
      router.replace(ROUTES.HOME);
    }

  }, [authInProgress, isLoading, user, segments, pathname]);




  if (isLoading && !DEV_MODE) return <Splash />;

  return (
    <>
     
      <Stack
        screenOptions={{
          headerShown: false,
          animation: "slide_from_right",
        }}
      />
    </>
  );

}

export default function RootLayout() {
  const [loaded] = useFonts({
    Manrope_300Light,
    Manrope_400Regular,
    Manrope_500Medium,
    Manrope_600SemiBold,
    Manrope_700Bold,
    Manrope_800ExtraBold,
  });

  if (!loaded) return null;

  return (
    <AuthProvider>
      <OnboardingProvider>
        <StatusBar style="dark" />
        <RootNavigation />
      </OnboardingProvider>
    </AuthProvider>
  );
}
